// Funciones de debug para verificar que tu app conecte correctamente con Tasmota

// Funci√≥n de prueba r√°pida de conectividad
async function pruebaRapidaConectividad() {
    const ip = deviceIP.value.trim();
    if (!ip) {
        showMessage('‚ö†Ô∏è Por favor ingresa la IP del dispositivo');
        return;
    }

    console.log(`üîç Probando conectividad con ${ip}...`);
    showMessage('Probando conectividad...', 'success');

    try {
        // Prueba 1: Status b√°sico
        console.log('üì° Prueba 1: Status b√°sico...');
        const statusUrl = `http://${ip}/cm?cmnd=Status`;
        const statusData = await fetchWithFallback(statusUrl);
        
        if (statusData.Status) {
            console.log('‚úÖ Tasmota responde correctamente');
            showMessage(`‚úÖ Tasmota ${statusData.Status.FriendlyName} conectado`, 'success');
        }

        // Prueba 2: Lectura de sensores
        console.log('üå°Ô∏è Prueba 2: Lectura de sensores...');
        const sensorUrl = `http://${ip}/cm?cmnd=Status%2010`;
        const sensorData = await fetchWithFallback(sensorUrl);
        
        console.log('üìä Datos completos del sensor:', sensorData);
        
        if (sensorData.StatusSNS) {
            console.log('‚úÖ StatusSNS encontrado:', sensorData.StatusSNS);
            
            // Buscar temperatura
            let temperaturaEncontrada = null;
            let sensorTipo = null;
            
            // Buscar DS18B20
            if (sensorData.StatusSNS.DS18B20) {
                temperaturaEncontrada = sensorData.StatusSNS.DS18B20.Temperature;
                sensorTipo = 'DS18B20';
                console.log(`üéØ DS18B20 encontrado: ${temperaturaEncontrada}¬∞C`);
            }
            // Buscar otros sensores
            else if (sensorData.StatusSNS.DHT11) {
                temperaturaEncontrada = sensorData.StatusSNS.DHT11.Temperature;
                sensorTipo = 'DHT11';
            }
            else if (sensorData.StatusSNS.DHT22) {
                temperaturaEncontrada = sensorData.StatusSNS.DHT22.Temperature;
                sensorTipo = 'DHT22';
            }
            // Temperature directo
            else if (sensorData.StatusSNS.Temperature !== undefined) {
                temperaturaEncontrada = sensorData.StatusSNS.Temperature;
                sensorTipo = 'Generic';
            }

            if (temperaturaEncontrada !== null && !isNaN(parseFloat(temperaturaEncontrada))) {
                console.log(`üå°Ô∏è Temperatura detectada: ${temperaturaEncontrada}¬∞C (Sensor: ${sensorTipo})`);
                showMessage(`üå°Ô∏è ${sensorTipo}: ${temperaturaEncontrada}¬∞C - ¬°Funciona perfectamente!`, 'success');
                
                // Actualizar la UI directamente
                tempActual = parseFloat(temperaturaEncontrada);
                lblTempActual.textContent = `${tempActual.toFixed(1)} ¬∞C`;
                lastUpdate.textContent = `${sensorTipo} - ${new Date().toLocaleTimeString()}`;
                updateConnectionStatus(true);
                
                return true;
            } else {
                console.log('‚ùå No se encontr√≥ temperatura v√°lida');
                showMessage('‚ùå Sensor configurado pero sin lectura v√°lida', 'error');
            }
        } else {
            console.log('‚ùå No se encontr√≥ StatusSNS');
            showMessage('‚ùå No hay datos de sensores. Verifica la configuraci√≥n.', 'error');
        }

        // Prueba 3: Estado del relay
        console.log('üîå Prueba 3: Estado del relay...');
        if (statusData.Status && statusData.Status.Power !== undefined) {
            relayStatus = statusData.Status.Power;
            console.log(`üîå Relay estado: ${relayStatus}`);
            updateStatusIndicator();
        }

        return false;

    } catch (error) {
        console.error('‚ùå Error en prueba de conectividad:', error);
        showMessage(`‚ùå Error: ${error.message}`, 'error');
        updateConnectionStatus(false);
        return false;
    }
}

// Funci√≥n para mostrar toda la informaci√≥n disponible del dispositivo
async function mostrarInfoCompleta() {
    const ip = deviceIP.value.trim();
    if (!ip) {
        showMessage('‚ö†Ô∏è Por favor ingresa la IP del dispositivo');
        return;
    }

    console.log('üìã Obteniendo informaci√≥n completa del dispositivo...');
    showMessage('Obteniendo informaci√≥n completa...', 'success');

    try {
        // Status completo
        const urls = [
            { name: 'Status General', url: `http://${ip}/cm?cmnd=Status` },
            { name: 'Status Red', url: `http://${ip}/cm?cmnd=Status%205` },
            { name: 'Status Sensores', url: `http://${ip}/cm?cmnd=Status%2010` },
            { name: 'Status GPIO', url: `http://${ip}/cm?cmnd=Status%2011` }
        ];

        for (let test of urls) {
            try {
                console.log(`\nüì° === ${test.name} ===`);
                const data = await fetchWithFallback(test.url);
                console.log(data);
            } catch (error) {
                console.log(`‚ùå Error en ${test.name}:`, error.message);
            }
        }

        showMessage('‚úÖ Informaci√≥n completa mostrada en la consola', 'success');

    } catch (error) {
        console.error('Error obteniendo informaci√≥n:', error);
        showMessage(`Error: ${error.message}`, 'error');
    }
}

// Funci√≥n para optimizar la lectura autom√°tica
function optimizarLecturaAutomatica() {
    // Detener timers existentes
    if (window.readingTimer) {
        clearInterval(window.readingTimer);
    }
    
    // Funci√≥n de lectura optimizada
    async function lecturaOptimizada() {
        const ip = deviceIP.value.trim();
        if (!ip) return;

        try {
            const url = `http://${ip}/cm?cmnd=Status%2010`;
            const data = await fetchWithFallback(url);
            
            // Log cada 10 lecturas para no saturar consola
            if (!window.lecturaCount) window.lecturaCount = 0;
            window.lecturaCount++;
            
            if (window.lecturaCount % 10 === 0) {
                console.log(`üìä Lectura #${window.lecturaCount}:`, data);
            }

            if (data.StatusSNS) {
                let temp = null;
                let sensor = 'Unknown';

                // Detectar sensor y temperatura
                if (data.StatusSNS.DS18B20) {
                    temp = parseFloat(data.StatusSNS.DS18B20.Temperature);
                    sensor = 'DS18B20';
                } else if (data.StatusSNS.DHT11) {
                    temp = parseFloat(data.StatusSNS.DHT11.Temperature);
                    sensor = 'DHT11';
                } else if (data.StatusSNS.DHT22) {
                    temp = parseFloat(data.StatusSNS.DHT22.Temperature);
                    sensor = 'DHT22';
                } else if (data.StatusSNS.Temperature !== undefined) {
                    temp = parseFloat(data.StatusSNS.Temperature);
                    sensor = 'Generic';
                }

                if (temp !== null && !isNaN(temp)) {
                    tempActual = temp;
                    lblTempActual.textContent = `${tempActual.toFixed(1)} ¬∞C`;
                    lastUpdate.textContent = `${sensor} - ${new Date().toLocaleTimeString()}`;
                    updateConnectionStatus(true);
                    
                    // Control autom√°tico
                    if (modoAutomatico) {
                        controlAutomatico();
                    }
                    
                    // Solo mostrar mensaje de √©xito la primera vez
                    if (!window.primeraLecturaExitosa) {
                        showMessage(`‚úÖ Lectura autom√°tica funcionando (${sensor})`, 'success');
                        window.primeraLecturaExitosa = true;
                    }
                } else {
                    throw new Error('Temperatura no v√°lida');
                }
            } else {
                throw new Error('StatusSNS no encontrado');
            }

        } catch (error) {
            console.error('Error en lectura autom√°tica:', error);
            updateConnectionStatus(false);
            
            // Solo mostrar error cada 5 intentos para no saturar
            if (window.errorCount % 5 === 0) {
                showMessage(`Error de lectura: ${error.message}`, 'error');
            }
            if (!window.errorCount) window.errorCount = 0;
            window.errorCount++;
        }
    }

    // Iniciar lectura autom√°tica cada 5 segundos
    window.readingTimer = setInterval(lecturaOptimizada, 5000);
    
    // Primera lectura inmediata
    lecturaOptimizada();
    
    console.log('üîÑ Lectura autom√°tica optimizada iniciada (cada 5 segundos)');
    showMessage('üîÑ Lectura autom√°tica iniciada', 'success');
}

// Funci√≥n para verificar configuraci√≥n espec√≠fica de nevera
async function verificarConfiguracionNevera() {
    console.log('‚ùÑÔ∏è Verificando configuraci√≥n espec√≠fica para nevera...');
    
    const temperaturaObjetivo = parseFloat(txtTempObjetivo.value) || 4;
    const tiempoDescanso = parseInt(txtDescanso.value) || 180;
    
    // Verificaciones de configuraci√≥n para nevera
    let warnings = [];
    
    if (temperaturaObjetivo < 2 || temperaturaObjetivo > 8) {
        warnings.push(`‚ö†Ô∏è Temperatura objetivo ${temperaturaObjetivo}¬∞C puede no ser √≥ptima para nevera (recomendado: 2-6¬∞C)`);
    }
    
    if (tiempoDescanso < 120) {
        warnings.push(`‚ö†Ô∏è Tiempo de descanso ${tiempoDescanso}s es muy corto para compresor (recomendado: m√≠n 120s)`);
    }
    
    if (warnings.length > 0) {
        warnings.forEach(warning => {
            console.log(warning);
            showMessage(warning, 'error');
        });
    } else {
        console.log('‚úÖ Configuraci√≥n √≥ptima para nevera');
        showMessage('‚úÖ Configuraci√≥n √≥ptima para nevera', 'success');
    }
    
    // Verificar si tenemos lectura de temperatura
    if (tempActual !== null) {
        console.log(`üå°Ô∏è Temperatura actual: ${tempActual}¬∞C`);
        if (tempActual > 10) {
            showMessage('‚ö†Ô∏è Temperatura muy alta para nevera. Verifica el sensor.', 'error');
        } else if (tempActual < -5) {
            showMessage('‚ö†Ô∏è Temperatura muy baja. Riesgo de congelaci√≥n.', 'error');
        } else {
            showMessage(`‚úÖ Temperatura actual normal: ${tempActual}¬∞C`, 'success');
        }
    }
}

// A√±adir botones de debug al DOM (opcional)
function agregarBotonesDebug() {
    const debugSection = document.createElement('div');
    debugSection.className = 'config-section';
    debugSection.innerHTML = `
        <div class="config-title">üîß Herramientas de Debug</div>
        <button class="button btn-update" onclick="pruebaRapidaConectividad()">üîç Prueba R√°pida</button>
        <button class="button btn-update" onclick="mostrarInfoCompleta()">üìã Info Completa</button>
        <button class="button btn-update" onclick="optimizarLecturaAutomatica()">üîÑ Optimizar Lectura</button>
        <button class="button btn-update" onclick="verificarConfiguracionNevera()">‚ùÑÔ∏è Verificar Nevera</button>
    `;
    
    // Insertar antes del √∫ltimo elemento
    const container = document.querySelector('.container');
    const versionInfo = document.querySelector('.version-info');
    container.insertBefore(debugSection, versionInfo);
}

// Hacer funciones globales para poder usarlas desde botones
window.pruebaRapidaConectividad = pruebaRapidaConectividad;
window.mostrarInfoCompleta = mostrarInfoCompleta;
window.optimizarLecturaAutomatica = optimizarLecturaAutomatica;
window.verificarConfiguracionNevera = verificarConfiguracionNevera;

// Auto-ejecutar prueba r√°pida cuando se carga
document.addEventListener('DOMContentLoaded', function() {
    // Agregar botones de debug (comentar si no los quieres)
    // agregarBotonesDebug();
    
    // Ejecutar prueba autom√°tica despu√©s de 3 segundos
    setTimeout(() => {
        if (deviceIP.value.trim()) {
            console.log('üöÄ Ejecutando prueba autom√°tica de conectividad...');
            pruebaRapidaConectividad();
        }
    }, 3000);
});
